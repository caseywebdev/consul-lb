#!/bin/sh

set -e

if [ ! -s /run/nginx/nginx.pid ]; then
  exit
fi

if [ "$USE_SSL" == "1" ]; then
  SERVER_NAMES=$(
    fgrep server_name /etc/nginx/nginx.conf |
    sed -E 's/\s*server_name\s+(.+?);/\1/' |
    sort
  )

  if [ "$SERVER_NAMES" ]; then
    echo "Checking if cert is valid for: $SERVER_NAMES"
    SERVER_NAMES_MD5=$(printf "$SERVER_NAMES" | md5sum | awk '{ print $1 }')
    KV_URL=$CONSUL_URL/v1/kv/$CONSUL_SERVICE_NAME/$LETSENCRYPT_TEST_CERT
    MD5_URL=$KV_URL/$SERVER_NAMES_MD5
    VERSION_URL=$KV_URL/version
    TMP_CERT=/tmp/fullchain.pem
    TMP_KEY=/tmp/privkey.pem
    CERT=/code/private/fullchain.pem
    KEY=/code/private/privkey.pem
    LE_DIR=/etc/letsencrypt/live/consul-lb
    LE_CERT=$LE_DIR/fullchain.pem
    LE_KEY=$LE_DIR/privkey.pem

    echo 'Pulling cert by server name MD5 from consul'
    curl -s $MD5_URL/fullchain.pem?raw > $TMP_CERT

    echo 'Pulling key by server name MD5 from consul'
    curl -s $MD5_URL/privkey.pem?raw > $TMP_KEY

    echo 'Checking if the cert will expire within the next 30 days'
    if openssl x509 -checkend 2592000 -in $TMP_CERT; then
      cp -f $TMP_CERT $CERT
      cp -f $TMP_KEY $KEY
    else
      ARGS='--webroot -n --agree-tos --cert-name=consul-lb -w /code/public'

      if [ "$LETSENCRYPT_TEST_CERT" == '1' ]; then
        ARGS="$ARGS --test-cert";
      fi

      if [ "$LETSENCRYPT_EMAIL_ADDRESS" ]; then
        ARGS="$ARGS --email=$LETSENCRYPT_EMAIL_ADDRESS"
      fi

      for SERVER_NAME in $SERVER_NAMES; do
        ARGS="$ARGS -d $SERVER_NAME";
      done

      echo 'Requesting cert from letsencrypt'
      if certbot certonly $ARGS; then
        echo 'Pushing current cert by server name MD5 to consul'
        curl -fsSXPUT $MD5_URL/fullchain.pem --data-binary @$LE_CERT > /dev/null

        echo 'Saving current key by server name MD5 to consul'
        curl -fsSXPUT $MD5_URL/privkey.pem --data-binary @$LE_KEY > /dev/null

        echo 'Updating cert version'
        VERSION=$(md5sum $LE_CERT | awk '{ print $1 }')
        curl -fsSXPUT $VERSION_URL -d $VERSION  > /dev/null

        # The version update above will trigger another consul-template run, so
        # let the nginx reload happen then.
        exit
      fi
    fi
  else
    echo 'No server names found, skipping cert checks'
  fi
fi

echo 'Reloading nginx'
exec nginx -s reload
