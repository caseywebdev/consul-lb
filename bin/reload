#!/bin/sh

set -e

while [ ! "`ps aux | grep [n]ginx`" ]; do sleep 1; done

if [ "$USE_SSL" == '1' ]; then
  SERVER_NAMES=`
    fgrep server_name /etc/nginx/nginx.conf |
    sed -E 's/\s*server_name\s+(.+?);/\1/' |
    sort
  `
  if [ "$SERVER_NAMES" ]; then
    SSL_DIR=/etc/ssl/private
    CERT_PATH=$SSL_DIR/fullchain.pem
    KEY_PATH=$SSL_DIR/privkey.pem

    LE_DIR=/etc/letsencrypt/live/consul-lb
    LE_CERT_PATH=$LE_DIR/fullchain.pem
    LE_KEY_PATH=$LE_DIR/privkey.pem

    KV_URL=$CONSUL_URL/v1/kv$CONSUL_KV_PATH/`printf "$SERVER_NAMES" | md5sum`

    echo 'Pulling cert from consul'
    set +e; curl -fs $KV_URL/fullchain.pem?raw > $CERT_PATH; set -e

    echo 'Pulling key from consul'
    set +e; curl -fs $KV_URL/privkey.pem?raw > $KEY_PATH; set -e

    if ![ openssl x509 -checkend 604800 -noout -in $CERT_PATH ]; then
      echo 'Cert is good for at least 7 more days'
    else
      echo 'Cert is out of date or does not exist'

      ARGS=''
      if [ "$LETSENCRYPT_TEST_CERT" == '1' ]; then ARGS+=' --test-cert'; fi
      for SERVER_NAME in ${SERVER_NAMES[*]}; do ARGS+=" -d $SERVER_NAME"; done

      echo 'Requesting cert from letsencrypt'
      certbot certonly -n --agree-tos --email=$LETSENCRYPT_EMAIL_ADDRESS \
        --cert-name=consul-lb --webroot -w /usr/local/nginx/html $ARGS

      echo "Copying to new cert/key $SSL_DIR"
      cp $LE_CERT_PATH $CERT_PATH
      cp $LE_KEY_PATH $KEY_PATH

      echo 'Saving current cert to consul'
      curl -sXPUT $KV_URL/fullchain.pem --data-binary @$CERT_PATH

      echo 'Saving current key to consul'
      curl -sXPUT $KV_URL/privkey.pem --data-binary @$KEY_PATH
    fi
  fi
fi

echo 'Reloading nginx'
nginx -s reload
